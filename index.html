<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <title>Meenakshi Finance - QR ро░роЪрпАродрпБ роЬрпЖройро░рпЗроЯрпНроЯро░рпН</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Meenakshi QR">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <link rel="manifest" href="./manifest.webmanifest">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  <style>
    body { background:#f5f6fa; }
    .app-card { border-radius:16px; }
    .app-title { color:#1f2937; }
    .form-label { font-weight:700; }
    .hint { color:#6b7280; font-size:.95rem; display:none; }
    .error { color:#b91c1c; font-size:.95rem; display:none; }
    .section-title { font-weight:700; }
    .kv { display:flex; justify-content:space-between; padding:.5rem 0; border-bottom:1px dashed #e5e7eb; }
    .kv:last-child { border-bottom:0; }
    .highlight { font-weight:800; }
    .big-number { font-size:clamp(1.35rem,4.5vw,1.75rem); }
    .meta-number { font-size:clamp(1rem,3.5vw,1.125rem); color:#374151; }
    .breakdown { font-size:1.1rem; font-weight:700; color:#111; margin-bottom:6px; }
    .qr-box { display:none; }
    .readonly { background:#eef2f7 !important; color:#6b7280 !important; border-color:#e5e7eb !important; cursor:not-allowed; }
    .mb-tight { margin-bottom:.5rem; }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="card shadow app-card">
      <div class="card-body p-4">
        <h1 class="h3 text-center app-title mb-2">Meenakshi Finance</h1>
        <h2 class="h5 text-center text-secondary mb-4">ро╡роЯрпНроЯро┐ роХрогроХрпНроХро┐роЯрпБроорпН рокропройрпНрокро╛роЯрпБ + QR ро░роЪрпАродрпБ</h2>
        <div class="mb-3">
          <label for="store" class="form-label">роХроЯрпИ/рокрпЖропро░рпН (Store)</label>
          <select id="store" class="form-select form-select-lg">
            <option value="KK">KK</option>
            <option value="Rajendran">Rajendran</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="amount" class="form-label">родрпКроХрпИ</label>
          <input id="amount" type="number" inputmode="decimal" class="form-control form-control-lg" placeholder="роЙродро╛: 43000">
          <div id="errAmount" class="error mt-1">роЪро░ро┐ропро╛рой родрпКроХрпИропрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН (0-роР ро╡ро┐роЯ роЕродро┐роХрооро╛роХ).</div>
        </div>
        <div class="mb-3">
          <label for="rate" class="form-label">ро╡роЯрпНроЯро┐ ро╡ро┐роХро┐родроорпН (%)</label>
          <input id="rate" type="text" class="form-control form-control-lg readonly" value="1.25" disabled aria-readonly="true">
          <div class="hint mt-1">ро╡ро┐роХро┐родроорпН роОрокрпНрокрпЛродрпБроорпН 1.25% (рооро╛родро╛роирпНродро┐ро░ роЕроЯро┐рокрпНрокроЯрпИ)</div>
        </div>
        <div class="mb-3">
          <label for="startDateText" class="form-label">роЕроЯроХрпБ рокро┐роЯро┐рокрпНрокрпБ родрпЗродро┐</label>
          <div class="input-group">
            <input id="startDateText" type="text" inputmode="numeric" class="form-control form-control-lg"
                   placeholder="DD/MM/YYYY" maxlength="10" autocomplete="off">
            <button class="btn btn-outline-secondary" type="button" id="openCalendar">ЁЯУЕ</button>
          </div>
          <div id="hintDateFmt" class="hint mt-1">родрпЗродро┐ ро╡роЯро┐ро╡роорпН: DD/MM/YYYY (роЙродро╛: 05/08/2025)</div>
          <div id="errStart" class="error mt-1">родрпЗродро┐ родро╡ро▒ро╛ройродрпБ роЕро▓рпНро▓родрпБ ро╡ро░рпБроЩрпНроХро╛ро▓ родрпЗродро┐ропро╛роХ роЗро░рпБроХрпНроХроХрпН роХрпВроЯро╛родрпБ.</div>
          <input id="startDateNative" type="date" class="visually-hidden" />
        </div>
        <div class="mb-3">
          <label for="today" class="form-label">роЗройрпНро▒рпБ</label>
          <input id="today" type="date" class="form-control form-control-lg readonly" readonly>
        </div>
        <div class="mb-4">
          <label class="form-label mb-tight">роХро╛ро▓роорпН (Duration)</label>
          <input id="durationText" type="text" class="form-control form-control-lg readonly" readonly placeholder="тАФ">
          <input id="autoDays" type="number" class="visually-hidden" readonly>
          <div id="durationLine" class="breakdown"></div>
        </div>
        <div id="results" class="card border-0 bg-light-subtle" style="display:none;">
          <div class="card-body">
            <div class="kv"><div>роорпБродро▓рпНродрпКроХрпИ</div><div id="outPrincipal" class="meta-number">тАФ</div></div>
            <div class="kv"><div>ро╡роЯрпНроЯро┐ ро╡ро┐роХро┐родроорпН</div><div id="outRate" class="meta-number">тАФ</div></div>
            <div class="kv"><div>роХро╛ро▓роорпН</div><div id="outDuration" class="meta-number">тАФ</div></div>
            <div class="card mt-3">
              <div class="card-body">
                <div class="section-title mb-1">родро┐ройроЪро░ро┐ (Daily)</div>
                <div id="dyBreakdown" class="breakdown">тАФ</div>
                <div class="kv"><div>роорпКродрпНрод ро╡роЯрпНроЯро┐</div><div id="dyInterest" class="big-number highlight">тАФ</div></div>
                <div class="kv"><div class="text-secondary">роорпКродрпНродроорпН (роорпБродро▓рпНродрпКроХрпИ + ро╡роЯрпНроЯро┐)</div><div id="dyTotal" class="meta-number">тАФ</div></div>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <div class="section-title mb-1">рооро╛родро╛роирпНродро┐ро░ (30 роиро╛роЯрпНроХро│рпН/рооро╛родроорпН)</div>
                <div id="moBreakdown" class="breakdown">тАФ</div>
                <div class="kv"><div>роорпКродрпНрод ро╡роЯрпНроЯро┐</div><div id="moInterest" class="big-number highlight">тАФ</div></div>
                <div class="kv"><div class="text-secondary">роорпКродрпНродроорпН (роорпБродро▓рпНродрпКроХрпИ + ро╡роЯрпНроЯро┐)</div><div id="moTotal" class="meta-number">тАФ</div></div>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <div class="section-title mb-1">ро╡ро░рпБроЯро╛роирпНродро┐ро░ (365 роиро╛роЯрпНроХро│рпН/ро╡ро░рпБроЯроорпН)</div>
                <div id="yrBreakdown" class="breakdown">тАФ</div>
                <div class="kv"><div>роорпКродрпНрод ро╡роЯрпНроЯро┐</div><div id="yrInterest" class="big-number highlight">тАФ</div></div>
                <div class="kv"><div class="text-secondary">роорпКродрпНродроорпН (роорпБродро▓рпНродрпКроХрпИ + ро╡роЯрпНроЯро┐)</div><div id="yrTotal" class="meta-number">тАФ</div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="d-grid gap-2 mt-3">
          <button id="btnGenQR" class="btn btn-primary btn-lg">QR роЙро░рпБро╡ро╛роХрпНроХрпБ & WhatsApp роЕройрпБрокрпНрокрпБ</button>
          <button id="btnReset" class="btn btn-outline-secondary btn-lg">роорпАроЯрпНроЯроорпИ</button>
        </div>
        <div id="qrSection" class="qr-box card mt-4">
          <div class="card-body text-center">
            <div class="h6 mb-2">QR ро░роЪрпАродрпБ</div>
            <div id="qrcode" class="d-inline-block p-2 bg-white rounded border"></div>
            <div class="d-grid gap-2 mt-3">
              <a id="downloadQR" class="btn btn-success btn-sm" download="meenakshi-receipt-qr.png">QR рокродро┐ро╡ро┐ро▒роХрпНроХрпБ (PNG)</a>
              <button id="btnWA" class="btn btn-success btn-lg">WhatsApp-ро▓рпН роЕройрпБрокрпНрокрпБ</button>
              <button id="btnShare" class="btn btn-outline-primary btn-sm">Share (Android/iOS)</button>
              <textarea id="receiptText" class="form-control mt-2" rows="6" readonly></textarea>
              <button id="copyText" class="btn btn-outline-secondary btn-sm">роЙро░рпИ роироХро▓рпЖроЯрпБ (Copy)</button>
            </div>
            <div class="hint mt-2" style="display:block;">роХро╡ройроорпН: WhatsApp родро╛ройро╛роХ роЕройрпБрокрпНрок роорпБроЯро┐ропро╛родрпБ; роЗроирпНрод рокрпКродрпНродро╛ройро╛ро▓рпН роЪрпЖропрпНродро┐ роорпБройрпН роиро┐ро░рокрпНрокрокрпНрокроЯрпНроЯрпБ родро┐ро▒роХрпНроХрпБроорпН.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // ---------- Helpers ----------
    function formatINR(v){ return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(v); }
    function r2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function toISOFromDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function diffDays(start, end){
      const sUTC = Date.UTC(start.getFullYear(), start.getMonth(), start.getDate());
      const eUTC = Date.UTC(end.getFullYear(), end.getMonth(), end.getDate());
      return Math.floor((eUTC - sUTC) / (1000*60*60*24));
    }
    function parseDMY(str){
      if (!/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return null;
      const [dd, mm, yyyy] = str.split('/').map(Number);
      const d = new Date(yyyy, mm - 1, dd);
      return (d.getFullYear() === yyyy && d.getMonth() + 1 === mm && d.getDate() === dd) ? d : null;
    }
    function autoFormatDMY(input){
      let v = input.value.replace(/[^\d]/g, '').slice(0,8);
      if (v.length >= 5) v = v.slice(0,2) + '/' + v.slice(2,4) + '/' + v.slice(4);
      else if (v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
      input.value = v;
    }
    function breakdownMonths(days){ return {m:Math.floor(days/30), d:days%30}; }
    function breakdownYears(days){
      const y = Math.floor(days/365);
      const rem = days % 365;
      return { y, m: Math.floor(rem/30), d: rem % 30 };
    }
    function humanMD(days){
      if (days % 30 === 0 && days > 0 && days < 365) return `${days} роиро╛ро│рпН`;
      const {m,d}=breakdownMonths(days);
      if (m>0 && d>0) return `${m} рооро╛родроорпН ${d} роиро╛ро│рпН`;
      if (m>0) return `${m} рооро╛родроорпН`;
      return `${d} роиро╛ро│рпН`;
    }
    function humanYMD(days){
      const {y,m,d}=breakdownYears(days);
      return `${y} ро╡ро░рпБроЯроорпН ${m} рооро╛родроорпН ${d} роиро╛ро│рпН`;
    }
    function humanDuration(days){
      if (days < 365) return humanMD(days);
      return humanYMD(days);
    }

    // ---------- Elements ----------
    const els = {
      store: document.getElementById('store'),
      amount: document.getElementById('amount'),
      rate: document.getElementById('rate'),
      startDateText: document.getElementById('startDateText'),
      startDateNative: document.getElementById('startDateNative'),
      openCalendar: document.getElementById('openCalendar'),
      today: document.getElementById('today'),
      durationText: document.getElementById('durationText'),
      autoDays: document.getElementById('autoDays'),
      errAmount: document.getElementById('errAmount'),
      errStart: document.getElementById('errStart'),
      hintDateFmt: document.getElementById('hintDateFmt'),
      results: document.getElementById('results'),
      outPrincipal: document.getElementById('outPrincipal'),
      outRate: document.getElementById('outRate'),
      outDuration: document.getElementById('outDuration'),
      dyBreakdown: document.getElementById('dyBreakdown'),
      moBreakdown: document.getElementById('moBreakdown'),
      yrBreakdown: document.getElementById('yrBreakdown'),
      dyInterest: document.getElementById('dyInterest'),
      dyTotal: document.getElementById('dyTotal'),
      moInterest: document.getElementById('moInterest'),
      moTotal: document.getElementById('moTotal'),
      yrInterest: document.getElementById('yrInterest'),
      yrTotal: document.getElementById('yrTotal'),
      btnReset: document.getElementById('btnReset'),
      durationLine: document.getElementById('durationLine'),
      btnGenQR: document.getElementById('btnGenQR'),
      qrSection: document.getElementById('qrSection'),
      qrcodeBox: document.getElementById('qrcode'),
      downloadQR: document.getElementById('downloadQR'),
      btnWA: document.getElementById('btnWA'),
      btnShare: document.getElementById('btnShare'),
      receiptText: document.getElementById('receiptText'),
      copyText: document.getElementById('copyText'),
    };

    // ---------- Init Today & Bind Calendar ----------
    function setTodayAndMax(){
      const now = new Date();
      const iso = toISOFromDate(now);
      els.today.value = iso;
      els.startDateNative.max = iso;
    }
    function syncFromNativeToText(){
      const v = els.startDateNative.value; if(!v) return;
      const [yyyy,mm,dd] = v.split('-');
      els.startDateText.value = `${dd}/${mm}/${yyyy}`;
    }
    function syncFromTextToNative(){
      const d = parseDMY(els.startDateText.value); if(!d) return;
      els.startDateNative.value = toISOFromDate(d);
    }

    // ---------- Validation ----------
    function setError(el, show){ el.style.display = show ? 'block' : 'none'; }
    function validate(showErrors){
      let ok = true;
      if(!(els.amount.value && Number(els.amount.value) > 0)){
        ok = false; if(showErrors) setError(els.errAmount, true);
      } else if(showErrors) setError(els.errAmount, false);

      const d = parseDMY(els.startDateText.value);
      const t = new Date(els.today.value);
      if(!d){
        ok = false; if(showErrors){ setError(els.errStart, true); setError(els.hintDateFmt, true); }
      } else if(d>t){
        ok = false; if(showErrors){ setError(els.errStart, true); setError(els.hintDateFmt, false); }
      } else if(showErrors){
        setError(els.errStart, false); setError(els.hintDateFmt, false);
      }
      return ok;
    }

    // ---------- Calculation ----------
    function recalcQuietly(){
      if(!validate(false)){
        els.results.style.display="none";
        els.durationText.value=""; els.autoDays.value=""; els.durationLine.textContent="";
        return null;
      }
      const P = Number(els.amount.value);
      const rate = 1.25;
      const d = parseDMY(els.startDateText.value);
      const t = new Date(els.today.value);
      const days = diffDays(d,t);
      els.autoDays.value = days;
      const durText = humanDuration(days);
      els.durationText.value = durText || "тАФ";
      els.durationLine.textContent = `роХро╛ро▓ роЕро│ро╡рпБ: ${durText} (${days} роиро╛ро│рпН)`;
      const monthly = P*(rate/100);
      const daily   = monthly/30;
      const yearly  = daily*365;
      const intDays = daily*days;
      const intMons = monthly*(days/30);
      const intYear = yearly*(days/365);
      els.outPrincipal.textContent = formatINR(P);
      els.outRate.textContent = rate + "%";
      els.outDuration.textContent = `${durText} (${days} роиро╛ро│рпН)`;
      const r=r2;
      els.dyBreakdown.textContent = `роиро╛роЯрпНроХро│рпН: ${days} роиро╛ро│рпН`;
      els.moBreakdown.textContent = `рооро╛род роЕро│ро╡рпБ: ${humanMD(days)}`;
      els.yrBreakdown.textContent = `ро╡ро░рпБроЯ роЕро│ро╡рпБ: ${humanYMD(days)}`;
      els.dyInterest.textContent = formatINR(r(intDays));
      els.dyTotal.textContent    = formatINR(r(P + intDays));
      els.moInterest.textContent = formatINR(r(intMons));
      els.moTotal.textContent    = formatINR(r(P + intMons));
      els.yrInterest.textContent = formatINR(r(intYear));
      els.yrTotal.textContent    = formatINR(r(P + intYear));
      els.results.style.display = "block";
      return {
        P, rate, days,
        monthly:r(intMons), daily:r(intDays), yearly:r(intYear),
        totalDaily:r(P+intDays), totalMonthly:r(P+intMons), totalYearly:r(P+intYear),
        dStr: els.startDateText.value,
        tStr: els.today.value.split('-').reverse().join('/'),
        humanMD: humanMD(days), humanYMD: humanYMD(days), durText
      };
    }

    // ---------- Receipt / QR / WhatsApp ----------
    const STORE_WA = { "KK": "9042231723", "Rajendran": "9942099588" };
    function buildReceiptText(calc){
      const lines = [
        "Meenakshi Finance - ро░роЪрпАродрпБ",
        "---------------------------",
        `роХроЯрпИ: ${els.store.value}`,
        `роорпБродро▓рпНродрпКроХрпИ: ${formatINR(calc.P)}`,
        `ро╡роЯрпНроЯро┐ ро╡ро┐роХро┐родроорпН: ${calc.rate}% (рооро╛родро╛роирпНродро┐ро░)`,
        `роЕроЯроХрпБ родрпЗродро┐: ${calc.dStr}`,
        `роЗройрпНро▒рпБ: ${calc.tStr}`,
        `роХро╛ро▓роорпН: ${calc.durText} (${calc.days} роиро╛ро│рпН)`,
        "",
        "роХрогроХрпНроХрпАроЯрпБроХро│рпН:",
        `тАв родро┐ройроЪро░ро┐ (роорпКродрпНрод ро╡роЯрпНроЯро┐): ${formatINR(calc.daily)} | роорпКродрпНродроорпН: ${formatINR(calc.totalDaily)}`,
        `тАв рооро╛родро╛роирпНродро┐ро░ (30 роиро╛ро│рпН): ${formatINR(calc.monthly)} | роорпКродрпНродроорпН: ${formatINR(calc.totalMonthly)}`,
        `тАв ро╡ро░рпБроЯро╛роирпНродро┐ро░ (365 роиро╛ро│рпН): ${formatINR(calc.yearly)} | роорпКродрпНродроорпН: ${formatINR(calc.totalYearly)}`,
        "",
        "роХрпБро▒ро┐рокрпНрокрпБ: 30 роиро╛ро│рпН = 1 рооро╛родроорпН, 365 роиро╛ро│рпН = 1 ро╡ро░рпБроЯроорпН (роЙро│рпНро│роХ ро╡ро┐родро┐роорпБро▒рпИроХро│рпН)."
      ];
      return lines.join("\n");
    }
    function generateQR(text){
      els.qrcodeBox.innerHTML = "";
      new QRCode(els.qrcodeBox, { text, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
      setTimeout(()=>{
        const img = els.qrcodeBox.querySelector('img');
        const cvs = els.qrcodeBox.querySelector('canvas');
        const dataURL = (img && img.src) || (cvs && cvs.toDataURL('image/png'));
        if (dataURL) els.downloadQR.href = dataURL;
      }, 300);
    }
    function openWhatsApp(text){
      const phone = STORE_WA[els.store.value];
      const encoded = encodeURIComponent(text);
      const url = `https://wa.me/${phone}?text=${encoded}`;
      window.open(url, "_blank");
    }

    // ---------- Robust auto-slash bindings ----------
    function handleDateTyping(){
      setTimeout(()=>{ autoFormatDMY(els.startDateText); syncFromTextToNative(); recalcOnInput(); }, 0);
    }
    ['input','beforeinput','keyup','change','paste','blur'].forEach(ev=>{
      els.startDateText.addEventListener(ev, handleDateTyping, { passive: true });
    });

    // Other inputs
    function recalcOnInput(){ recalcQuietly(); }
    els.amount.addEventListener('input', recalcOnInput);
    els.openCalendar.addEventListener('click', ()=>{ els.startDateNative.showPicker ? els.startDateNative.showPicker() : els.startDateNative.click(); });
    els.startDateNative.addEventListener('change', ()=>{ syncFromNativeToText(); recalcOnInput(); });

    // Submit
    document.getElementById('btnGenQR').addEventListener('click', ()=>{
      const ok = validate(true);
      if(!ok){
        if(els.errAmount.style.display==='block'){ els.amount.focus(); }
        else if(els.errStart.style.display==='block'){ els.startDateText.focus(); }
        return;
      }
      const calc = recalcQuietly(); if(!calc) return;
      const receipt = buildReceiptText(calc);
      els.receiptText.value = receipt;
      generateQR(receipt);
      els.qrSection.style.display = "block";
      els.btnWA.onclick = ()=> openWhatsApp(receipt);
      els.btnShare.onclick = async ()=>{
        if(navigator.share){
          try{ await navigator.share({ text: receipt, title: "Meenakshi Finance - Receipt" }); }catch(e){}
        } else { alert("Share API not supported. Use WhatsApp button or copy text."); }
      };
    });

    // Copy & Reset
    document.getElementById('copyText').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(els.receiptText.value || "");
        els.copyText.textContent = "роироХро▓рпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯродрпБ тЬУ";
        setTimeout(()=> els.copyText.textContent = "роЙро░рпИ роироХро▓рпЖроЯрпБ (Copy)", 1500);
      }catch(e){ alert("роХрпНро│ро┐рокрпНрокрпЛро░рпНроЯро┐ро▓рпН роХро╛рокрпНрокро┐ роЪрпЖропрпНроп роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ."); }
    });
    document.getElementById('btnReset').addEventListener('click', ()=>{
      els.amount.value = "";
      els.startDateText.value = "";
      els.startDateNative.value = "";
      els.durationText.value = "";
      els.autoDays.value = "";
      [els.errAmount, els.errStart, els.hintDateFmt].forEach(x=> x.style.display='none');
      els.results.style.display = "none";
      els.qrSection.style.display = "none";
      els.qrcodeBox.innerHTML = "";
      els.receiptText.value = "";
      setTodayAndMax();
    });

    // PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }
    window.addEventListener('load', ()=>{ setTodayAndMax(); recalcQuietly(); });
  </script>
</body>
</html>
